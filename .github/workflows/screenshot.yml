name: Screen Captures

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  screenshot:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v6

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build
        run: bun run build
        env:
          BASE_PATH: /splotch/

      - name: Install Playwright
        run: |
          bun add -d playwright
          bunx playwright install chromium

      - name: Start preview server and take screenshot
        run: |
          # Start preview server in background
          bun run preview > /dev/null 2>&1 &
          PREVIEW_PID=$!

          # Wait for server to be ready
          echo "Waiting for preview server to start..."
          for i in {1..30}; do
            if curl -s http://localhost:4173/splotch/ > /dev/null 2>&1; then
              echo "Server is ready!"
              break
            fi
            sleep 1
          done

          # Take screenshot
          node << 'EOF'
          const { chromium } = require('playwright');
          (async () => {
            const browser = await chromium.launch();
            const page = await browser.newPage();
            await page.setViewportSize({ width: 1920, height: 1080 });
            await page.goto('http://localhost:4173/splotch/?geom=fling&strokes=1&dir=0.75&fp=25', { waitUntil: 'networkidle' });
            // Wait for any animations or dynamic content to settle
            await page.waitForTimeout(3000);
            await page.screenshot({ path: 'capture.png', fullPage: true });
            console.log('Screenshot for geom=fling&strokes=1&dir=0.5 saved successfully');
            await page.goto('http://localhost:4173/splotch/?geom=fling&strokes=3&dir=0.5&fp=28', { waitUntil: 'networkidle' });
            await page.waitForTimeout(3000);
            await page.screenshot({ path: 'capture2.png', fullPage: true });
            console.log('Screenshot for geom=fling&strokes=3&dir=0.5 saved successfully');
            await browser.close();
          })();
          EOF

          # Stop preview server
          kill $PREVIEW_PID || true
        env:
          BASE_PATH: /splotch/

      - name: Create orphan branch and commit screenshot
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Store screenshot in a temporary location outside git
          cp capture.png /tmp/capture.png
          cp capture2.png /tmp/capture2.png

          # Always start from main/master branch for a clean base
          git checkout main || git checkout master || true

          # Delete local screenshots branch if it exists
          git branch -D screenshots 2>/dev/null || true

          # Always create a fresh orphan branch (no history)
          git checkout --orphan screenshots

          # Remove all files from git index and working directory
          git rm -rf . 2>/dev/null || true

          # Copy screenshot to the branch
          cp /tmp/capture.png .
          cp /tmp/capture2.png .
          echo "# Screenshot Branch" > README.md
          echo "This branch contains automated screenshots for inclusion in the documentation." >> README.md
          echo -e "\n![capture-1](capture.png)\n" >> README.md
          echo -e "\n![capture-2 2](capture2.png)\n" >> README.md

          # Commit only the screenshot (first and only commit)
          git add capture*.png README.md
          git commit -m "Update landing page screenshots [skip ci]"

          # Force push to replace remote branch completely
          git push origin screenshots --force

          # Success message
          echo "Done!"
          echo "Orphan branch: https://github.com/mindthemath/splotch/tree/screenshots"
